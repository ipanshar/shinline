import{j as e,r as p,a as _,L as T}from"./app-DUyv2vMF.js";import{A as D}from"./app-layout-D3aOKE7C.js";import{u as I}from"./useTranslation-s2IH1_qR.js";import"./button-g_VPEBkA.js";import"./index-BUl_ciKf.js";import"./index-BGR1gm8V.js";import"./shin-line-logo-DeoKgELm.js";const $=d=>{if(!d)return"—";const s=new Date(d);return new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(s)},P=({tasks:d})=>e.jsx("div",{className:"overflow-x-auto rounded-lg shadow border border-gray-300",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700 w-12",children:"ID"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700 min-w-[120px]",children:"Рейс / Статус"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700 min-w-[140px]",children:"План / Прибытие / Убытие"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700 min-w-[100px]",children:"Описание"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700 min-w-[100px]",children:"Автопарк"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700 min-w-[160px]",children:"Контакты / Водитель"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold text-gray-700 min-w-[180px]",children:"Погрузка"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:d.map(s=>e.jsxs("tr",{className:"hover:bg-gray-50 transition-colors duration-150 cursor-pointer",title:`Рейс ${s.name}, Статус: ${s.status_name}`,children:[e.jsx("td",{className:"px-4 py-3 align-top font-mono text-gray-600",children:s.id}),e.jsxs("td",{className:"px-4 py-3 align-top space-y-1",children:[e.jsx("div",{className:"font-semibold text-gray-800",children:s.name}),e.jsx("div",{className:"text-sm text-gray-500",children:s.status_name}),e.jsx("div",{className:"text-xs text-gray-400",children:s.yard_name})]}),e.jsxs("td",{className:"px-4 py-3 align-top space-y-1 font-mono text-gray-700",children:[e.jsxs("div",{children:["План: ",$(s.plan_date)]}),e.jsxs("div",{children:["Прибытие: ",$(s.begin_date)]}),e.jsxs("div",{children:["Убытие: ",$(s.end_date)]})]}),e.jsx("td",{className:"px-4 py-3 align-top max-w-xs text-gray-700 break-words whitespace-normal",children:s.description||"—"}),e.jsxs("td",{className:"px-4 py-3 align-top space-y-1 text-gray-700 text-xs font-mono",children:[e.jsxs("div",{children:[e.jsx("b",{children:"Тр.: "}),s.truck_plate_number]}),s.trailer_plate_number&&e.jsxs("div",{children:[e.jsx("b",{children:"Пр.: "}),s.trailer_plate_number]}),s.truck_model&&e.jsxs("div",{children:[e.jsx("b",{children:"Модель: "}),s.truck_model]}),s.truck_category_name&&e.jsxs("div",{children:[e.jsx("b",{children:"Катег.: "}),s.truck_category_name]}),s.color&&e.jsxs("div",{children:[e.jsx("b",{children:"Цвет: "}),s.color]})]}),e.jsxs("td",{className:"px-4 py-3 align-top space-y-1 text-gray-700 text-sm",children:[e.jsxs("div",{children:[e.jsx("b",{children:"Автор: "}),s.avtor," ",s.phone&&`(${s.phone})`]}),e.jsxs("div",{children:[e.jsx("b",{children:"Водитель: "}),s.user_name]}),e.jsxs("div",{children:[e.jsx("b",{children:"Логин: "}),s.user_login]}),e.jsxs("div",{children:[e.jsx("b",{children:"Телефон: "}),s.user_phone]})]}),e.jsx("td",{className:"px-4 py-3 align-top space-y-3 max-w-[220px] text-gray-700 text-xs",children:s.task_loadings.length===0?e.jsx("div",{children:"—"}):s.task_loadings.map((u,b)=>e.jsxs("div",{className:"p-2 bg-gray-50 rounded border border-gray-200",children:[e.jsx("div",{className:"font-semibold",children:u.warehouse_name}),e.jsxs("div",{children:["План: ",e.jsx("span",{className:"text-green-600",children:u.warehouse_gate_plan_name||"—"})]}),e.jsxs("div",{children:["Факт: ",e.jsx("span",{className:"text-red-600",children:u.warehouse_gate_fact_name||"—"})]})]},b))})]},s.id))})]})}),E={name:"",sorting_order:1,gates:[],plan_gate:null,description:null},M={task_id:null,name:"",login:"",user_name:"",user_phone:"",company:"",plate_number:"",trailer_plate_number:"",truck_model:"",truck_category:"",trailer_type:"",trailer_model:"",color:"",vin:"",avtor:"",phone:"",Yard:"",description:"",plan_date:"",weighing:!1,warehouse:[{...E}]},F=({isOpen:d,onClose:s})=>{const[u,b]=p.useState([]),[y,f]=p.useState([]),[x,h]=p.useState({}),[n,m]=p.useState(M);p.useEffect(()=>{d&&(_.post("/yard/getyards").then(a=>{const t=a.data.data;Array.isArray(t)?b(t):b([])}).catch(()=>b([])),_.post("/warehouse/getwarehouses").then(a=>{const t=a.data.data;Array.isArray(t)?f(t):f([])}).catch(()=>f([])))},[d]);const k=(a,t)=>{const r=y.find(l=>l.name===a);if(!r){h(l=>{const c={...l};return delete c[t],c}),m(l=>{const c=[...l.warehouse];return c[t].plan_gate=null,c[t].gates=[],{...l,warehouse:c}});return}_.post("/warehouse/getwarehouses",{warehouse_id:r.id}).then(l=>{const c=l.data.data;Array.isArray(c)?(h(g=>({...g,[t]:c})),m(g=>{const i=[...g.warehouse];return i[t].gates=c.map(j=>j.name),c.some(j=>j.name===i[t].plan_gate)||(i[t].plan_gate=null),{...g,warehouse:i}})):(h(g=>{const i={...g};return delete i[t],i}),m(g=>{const i=[...g.warehouse];return i[t].plan_gate=null,i[t].gates=[],{...g,warehouse:i}}))}).catch(()=>{h(l=>{const c={...l};return delete c[t],c}),m(l=>{const c=[...l.warehouse];return c[t].plan_gate=null,c[t].gates=[],{...l,warehouse:c}})})},o=a=>{const{name:t,type:r,value:l,checked:c,dataset:g}=a.target;if(g.index!==void 0){const i=Number(g.index);m(j=>{const A=[...j.warehouse],N={...A[i]};return t==="sorting_order"?N.sorting_order=Number(l):t==="plan_gate"?N.plan_gate=l||null:t==="description"?N.description=l||null:N.name=l,A[i]=N,{...j,warehouse:A}}),t==="name"&&k(l,i)}else m(r==="checkbox"?i=>({...i,[t]:c}):i=>({...i,[t]:l}))},v=()=>{m(a=>{const t=[...a.warehouse];return t.push({name:"",sorting_order:t.length+1,gates:[],plan_gate:null,description:null}),{...a,warehouse:t}})},w=a=>{m(t=>{const r=t.warehouse.filter((l,c)=>c!==a);return r.forEach((l,c)=>l.sorting_order=c+1),{...t,warehouse:r}}),h(t=>{const r={...t};return delete r[a],r})},C=a=>{const t=new Date(a),r=l=>String(l).padStart(2,"0");return`${t.getFullYear()}-${r(t.getMonth()+1)}-${r(t.getDate())} ${r(t.getHours())}:${r(t.getMinutes())}:${r(t.getSeconds())}`},S=async()=>{var a;try{const t={...n,task_id:n.task_id??null,plan_date:C(n.plan_date)};console.log("Payload:",t),await _.post("/api/task/addapitask",t),alert("Задача успешно добавлена"),s(),m(M),h({})}catch(t){const r=t;r.response?(console.error("Response data:",r.response.data),console.error("Status:",r.response.status),console.error("Headers:",r.response.headers),alert("Ошибка сервера: "+(((a=r.response.data)==null?void 0:a.message)||"Неизвестная ошибка"))):(console.error("Unexpected error:",t),alert("Произошла неизвестная ошибка"))}};return d?e.jsx("div",{className:"fixed inset-0 bg-gray-400/20 bg-opacity-10 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-auto",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center border-b pb-3",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Добавить задачу"}),e.jsx("button",{onClick:s,className:"text-gray-500 hover:text-red-600 text-2xl",children:"×"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Название задачи (name) *",e.jsx("input",{type:"text",name:"name",value:n.name,onChange:o,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Автор (автор) *",e.jsx("input",{type:"text",name:"avtor",value:n.avtor,onChange:o,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Пользователь (user_name)",e.jsx("input",{type:"text",name:"user_name",value:n.user_name,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Логин пользователя (login)",e.jsx("input",{type:"text",name:"login",value:n.login,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Телефон пользователя (user_phone)",e.jsx("input",{type:"text",name:"user_phone",value:n.user_phone,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Компания (company)",e.jsx("input",{type:"text",name:"company",value:n.company,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Номер машины (plate_number)",e.jsx("input",{type:"text",name:"plate_number",value:n.plate_number,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Номер прицепа (trailer_plate_number)",e.jsx("input",{type:"text",name:"trailer_plate_number",value:n.trailer_plate_number,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Модель грузовика (truck_model)",e.jsx("input",{type:"text",name:"truck_model",value:n.truck_model,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Категория грузовика (truck_category)",e.jsx("input",{type:"text",name:"truck_category",value:n.truck_category,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Тип прицепа (trailer_type)",e.jsx("input",{type:"text",name:"trailer_type",value:n.trailer_type,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Модель прицепа (trailer_model)",e.jsx("input",{type:"text",name:"trailer_model",value:n.trailer_model,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Цвет (color)",e.jsx("input",{type:"text",name:"color",value:n.color,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["VIN (vin)",e.jsx("input",{type:"text",name:"vin",value:n.vin,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Телефон (phone)",e.jsx("input",{type:"text",name:"phone",value:n.phone,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Описание (description)",e.jsx("textarea",{name:"description",value:n.description,onChange:o,rows:2,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Дата планирования (plan_date)",e.jsx("input",{type:"datetime-local",name:"plan_date",value:n.plan_date,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm font-medium text-gray-700",children:[e.jsx("input",{type:"checkbox",name:"weighing",checked:n.weighing,onChange:a=>m(t=>({...t,weighing:a.target.checked})),className:"form-checkbox h-5 w-5 text-blue-600"}),e.jsx("span",{children:"Весовой контроль (weighing)"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Двор (Yard) *",e.jsxs("select",{name:"Yard",value:n.Yard,onChange:o,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200",children:[e.jsx("option",{value:"",children:"Выберите двор"}),u.map(a=>e.jsx("option",{value:a.name,children:a.name},a.id))]})]})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Склады и ворота"}),n.warehouse.map((a,t)=>e.jsxs("div",{className:"border rounded p-4 mb-4 relative bg-gray-50",children:[e.jsx("button",{type:"button",onClick:()=>w(t),className:"absolute top-2 right-2 text-red-500 hover:text-red-700 text-lg font-bold",title:"Удалить склад",children:"×"}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Склад ",t+1,e.jsxs("select",{name:"name","data-index":t,value:a.name,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 mt-1",children:[e.jsx("option",{value:"",children:"Выберите склад"}),y.map(r=>e.jsx("option",{value:r.name,children:r.name},r.id))]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Порядок сортировки",e.jsx("input",{type:"number",name:"sorting_order","data-index":t,value:a.sorting_order,min:1,onChange:o,className:"w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 mt-1"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Ворота (plan_gate)",e.jsxs("select",{name:"plan_gate","data-index":t,value:a.plan_gate||"",onChange:o,disabled:!Array.isArray(x[t])||x[t].length===0,className:"w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 mt-1",children:[e.jsx("option",{value:"",children:"Выберите ворота"}),Array.isArray(x[t])&&x[t].map(r=>e.jsx("option",{value:r.name,children:r.name},r.id))]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Описание",e.jsx("textarea",{name:"description","data-index":t,value:a.description||"",onChange:o,rows:2,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]})]},t)),e.jsx("button",{type:"button",onClick:v,className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition",children:"Добавить склад"})]}),e.jsxs("div",{className:"flex justify-end space-x-4 pt-4 border-t",children:[e.jsx("button",{onClick:s,className:"px-4 py-2 rounded border border-gray-400 hover:border-gray-600 transition",children:"Отмена"}),e.jsx("button",{onClick:S,className:"px-6 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition",children:"Сохранить"})]})]})}):null},Y=()=>{const[d,s]=p.useState([]),[u,b]=p.useState(!1),[y,f]=p.useState(null),[x,h]=p.useState(1),[n,m]=p.useState(1),[k,o]=p.useState(!1),v=sessionStorage.getItem("user");let w=!1;if(v)try{const t=JSON.parse(v);w=Array.isArray(t.roles)&&t.roles.includes("Снабженец")}catch(t){console.error("Ошибка парсинга user из sessionStorage:",t)}const C=t=>{b(!0),f(null),_.post("/task/gettasks",{page:t}).then(r=>{r.data.status?(s(r.data.data.tasks||r.data.data),m(r.data.data.totalPages||1)):(f("Ошибка при загрузке задач"),s([]))}).catch(r=>{f(r.message||"Ошибка запроса"),s([])}).finally(()=>{b(!1)})};p.useEffect(()=>{C(x)},[x]);const S=()=>h(t=>Math.max(1,t-1)),a=()=>h(t=>Math.min(n,t+1));return e.jsxs("div",{className:"p-5",children:[w&&e.jsx("div",{className:"mb-4",children:e.jsx("button",{onClick:()=>o(!0),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Добавить"})}),u&&e.jsx("div",{children:"Загрузка задач..."}),y&&e.jsxs("div",{className:"text-red-600",children:["Ошибка: ",y]}),!u&&!y&&d.length===0&&e.jsx("div",{children:"Задачи не найдены"}),!u&&!y&&d.length>0&&e.jsx(P,{tasks:d}),e.jsxs("div",{className:"mt-4 flex items-center justify-center space-x-4",children:[e.jsx("button",{onClick:S,disabled:x===1||u,className:`px-4 py-2 rounded border ${x===1||u?"bg-gray-200 cursor-not-allowed":"bg-white hover:bg-gray-100"}`,children:"Назад"}),e.jsxs("span",{className:"text-gray-700",children:["Страница ",x," из ",n]}),e.jsx("button",{onClick:a,disabled:x===n||u,className:`px-4 py-2 rounded border ${x===n||u?"bg-gray-200 cursor-not-allowed":"bg-white hover:bg-gray-100"}`,children:"Вперед"})]}),e.jsx(F,{isOpen:k,onClose:()=>o(!1)})]})};function U(){const{t:d}=I(),s=[{title:d("tasks"),href:"/tasks"}];return e.jsxs(D,{breadcrumbs:s,children:[e.jsx(T,{title:d("tasks")}),e.jsx(Y,{})]})}export{U as default};
