import{r as d,a as _,j as e,L as Z}from"./app-CqFx5Rqn.js";import{A as ee}from"./app-layout-D5CBteLY.js";import{u as te}from"./useTranslation-Y75jHl6b.js";import"./button-CulBlrr3.js";import"./index-D9wv9xhR.js";import"./index-PxyD74vO.js";import"./shin-line-logo-DeoKgELm.js";const se={name:"",sorting_order:1,gates:[],plan_gate:null,description:null},O={task_id:null,name:"",login:"",user_name:"",user_phone:"",company:"",plate_number:"",trailer_plate_number:"",truck_model:"",truck_category:"",trailer_type:"",trailer_model:"",color:"",vin:"",avtor:"",phone:"",Yard:"",description:"",plan_date:"",end_date:"",weighing:!1,create_user_id:"",one_permission:!1,warehouse:[{...se}]},re=({taskId:b,isOpen:p,onClose:j})=>{var r;const[C,N]=d.useState([]),[T,c]=d.useState([]),[y,u]=d.useState({}),[i,x]=d.useState(O),[$,v]=d.useState([]),[A,M]=d.useState(""),[E,f]=d.useState(!1),[m,k]=d.useState(null),[Y,G]=d.useState(null),[W,P]=d.useState(null),[H,U]=d.useState(),q=s=>s?s.replace(" ","T").slice(0,16):"";d.useEffect(()=>{const s=sessionStorage.getItem("user");if(s){const t=JSON.parse(s);U(t.id)}},[]),d.useEffect(()=>{p&&_.get("/users/without-roles").then(s=>v(s.data)).catch(()=>v([]))},[p]),d.useEffect(()=>{p&&(_.post("/yard/getyards").then(s=>{const t=s.data.data;Array.isArray(t)?N(t):N([])}).catch(()=>N([])),_.post("/warehouse/getwarehouses").then(s=>{const t=s.data.data;Array.isArray(t)?c(t):c([])}).catch(()=>c([])))},[p]),d.useEffect(()=>{if(!A.trim()){k(null);return}Y&&clearTimeout(Y);const s=setTimeout(()=>{R()},600);G(s)},[A]),d.useEffect(()=>{p&&(_.post("/yard/getyards").then(s=>N(s.data.data||[])).catch(()=>N([])),_.post("/warehouse/getwarehouses").then(s=>c(s.data.data||[])).catch(()=>c([])),_.get("/users/without-roles").then(s=>v(s.data)).catch(()=>v([])),_.post("/task/gettasks",{task_id:b}).then(s=>{var o;const t=s.data.data;x({...O,task_id:t.id,name:t.name,avtor:t.avtor,login:t.user_login,user_name:t.user_name,user_phone:t.user_phone,company:t.company||"",plate_number:t.truck_plate_number,trailer_plate_number:t.trailer_plate_number||"",truck_model:t.truck_model_name||"",truck_category:t.truck_category_name||"",trailer_type:t.trailer_type_name||"",color:t.color||"",vin:"",phone:t.phone||"",description:t.description||"",plan_date:q(t.plan_date),end_date:q(t.end_date),weighing:!!((o=t.task_weighings)!=null&&o.length),one_permission:!1,create_user_id:"",Yard:t.yard_name,warehouse:t.task_loadings.map((l,h)=>({name:l.warehouse_name,sorting_order:h+1,gates:[],plan_gate:l.warehouse_gate_plan_name||null,description:null}))});const a=i.plate_number;M(a),t.task_loadings.forEach((l,h)=>{w(l.warehouse_name,h)})}).catch(s=>console.error(s)),console.log())},[p,b]);const R=async()=>{if(A.trim()){f(!0);try{const s=await _.get("/trucs/search",{params:{plate_number:A}});k(s.data.found?s.data.data:null)}catch(s){console.error(s),k(null)}finally{f(!1)}}},L=()=>{alert("Создание ТС пока не реализовано")},J=()=>{m&&(x(s=>({...s,plate_number:m.plate_number,truck_model:m.truck_model_name||"",truck_category:m.truck_category_name||"",trailer_type:m.trailer_type_name||"",trailer_model:m.trailer_model_name||"",color:m.color||"",vin:m.vin||""})),P(m))},w=(s,t)=>{const a=T.find(o=>o.name===s);if(!a){u(o=>{const l={...o};return delete l[t],l}),x(o=>{const l=[...o.warehouse];return l[t].plan_gate=null,l[t].gates=[],{...o,warehouse:l}});return}_.post("/warehouse/getgates",{warehouse_id:a.id}).then(o=>{const l=o.data.data;Array.isArray(l)?(u(h=>({...h,[t]:l})),x(h=>{const g=[...h.warehouse];return g[t].gates=l.map(I=>I.name),l.some(I=>I.name===g[t].plan_gate)||(g[t].plan_gate=null),{...h,warehouse:g}})):(u(h=>{const g={...h};return delete g[t],g}),x(h=>{const g=[...h.warehouse];return g[t].plan_gate=null,g[t].gates=[],{...h,warehouse:g}}))}).catch(()=>{u(o=>{const l={...o};return delete l[t],l}),x(o=>{const l=[...o.warehouse];return l[t].plan_gate=null,l[t].gates=[],{...o,warehouse:l}})})},V=s=>{const t=Number(s.target.value),a=$.find(o=>o.id===t);x(o=>({...o,user_name:a.user_name,login:a.login,user_phone:a.user_phone}))},S=s=>{const{name:t,type:a,value:o,checked:l,dataset:h}=s.target;if(h.index!==void 0){const g=Number(h.index);x(I=>{const K=[...I.warehouse],F={...K[g]};return t==="sorting_order"?F.sorting_order=Number(o):t==="plan_gate"?F.plan_gate=o||null:t==="description"?F.description=o||null:F.name=o,K[g]=F,{...I,warehouse:K}}),t==="name"&&w(o,g)}else x(a==="checkbox"?g=>({...g,[t]:l}):g=>({...g,[t]:o}))},z=()=>{x(s=>{const t=[...s.warehouse];return t.push({name:"",sorting_order:t.length+1,gates:[],plan_gate:null,description:null}),{...s,warehouse:t}})},B=s=>{x(t=>{const a=t.warehouse.filter((o,l)=>l!==s);return a.forEach((o,l)=>o.sorting_order=l+1),{...t,warehouse:a}}),u(t=>{const a={...t};return delete a[s],a})},D=s=>{const t=new Date(s),a=o=>String(o).padStart(2,"0");return`${t.getFullYear()}-${a(t.getMonth()+1)}-${a(t.getDate())} ${a(t.getHours())}:${a(t.getMinutes())}:${a(t.getSeconds())}`},n=async()=>{var s;try{const t=i.warehouse.map(o=>({name:o.name,sorting_order:o.sorting_order,gates:o.gates,plan_gate:o.plan_gate,description:o.description,barcode:o.barcode??null,yard:o.yard??null,document:o.document??null})),a={...i,task_id:i.task_id??null,plan_date:D(i.plan_date),end_date:D(i.end_date),warehouse:t,create_user_id:H};console.log("Payload:",a),await _.post("/api/task/addapitask",a),alert("Задача успешно добавлена"),j(),x(O),u({})}catch(t){const a=t;a.response?(console.error("Response data:",a.response.data),console.error("Status:",a.response.status),console.error("Headers:",a.response.headers),alert("Ошибка сервера: "+(((s=a.response.data)==null?void 0:s.message)||"Неизвестная ошибка"))):(console.error("Unexpected error:",t),alert("Произошла неизвестная ошибка"))}};return p?e.jsx("div",{className:"fixed inset-0 bg-gray-400/20 bg-opacity-10 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-auto",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center border-b pb-3",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Редактировать задачу"}),e.jsx("button",{onClick:j,className:"text-gray-500 hover:text-red-600 text-2xl",children:"×"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Название задачи (name) *",e.jsx("input",{type:"text",name:"name",value:i.name,onChange:S,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Автор (автор) *",e.jsx("input",{type:"text",name:"avtor",value:i.avtor,onChange:S,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Выберите пользователя",e.jsxs("select",{name:"user_id",value:i.login?((r=$.find(s=>s.login===i.login))==null?void 0:r.id)??"":"",onChange:V,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200",children:[e.jsx("option",{value:"",children:"— Выберите —"}),$.map(s=>e.jsx("option",{value:s.id,children:s.user_name},s.id))]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Компания (company)",e.jsx("input",{type:"text",name:"company",value:i.company,onChange:S,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Поиск ТС по номеру",e.jsxs("div",{className:"flex mt-1",children:[e.jsx("input",{type:"text",value:A,onChange:s=>M(s.target.value),placeholder:"Введите номер машины",className:"flex-1 border border-gray-300 rounded-l px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"}),e.jsx("button",{type:"button",onClick:R,disabled:E,className:"bg-blue-600 text-white px-4 py-2 rounded-r hover:bg-blue-700 disabled:opacity-50",children:E?"Поиск...":"Найти"})]})]}),m!==null?e.jsxs("div",{className:"p-3 bg-green-50 rounded border border-green-200",children:[e.jsx("p",{className:"text-green-800",children:"ТС найдено:"}),e.jsxs("ul",{className:"text-gray-700",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Номер:"})," ",m.plate_number]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Модель:"})," ",m.truck_model_name]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Прицеп:"})," ",m.trailer_model_name]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Цвет:"})," ",m.color]}),e.jsxs("li",{children:[e.jsx("strong",{children:"VIN:"})," ",m.vin]})]}),W?e.jsx("button",{type:"button",onClick:()=>{P(null),k(null),M("")},className:"mt-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700",children:"Отвязать ТС"}):e.jsx("button",{type:"button",onClick:J,className:"mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",children:"Выбрать ТС"})]}):!E&&A&&e.jsxs("div",{className:"p-3 bg-yellow-50 rounded border border-yellow-200",children:[e.jsx("p",{className:"text-yellow-800",children:"ТС с таким номером не найдено."}),e.jsx("button",{type:"button",onClick:L,className:"mt-2 bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700",children:"Создать ТС"})]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Описание (description)",e.jsx("textarea",{name:"description",value:i.description,onChange:S,rows:2,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Дата планирования (plan_date)",e.jsx("input",{type:"datetime-local",name:"plan_date",value:i.plan_date,onChange:S,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Телефон (phone)",e.jsx("input",{type:"text",name:"phone",value:i.phone,onChange:S,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Крайний срок (end_date)",e.jsx("input",{type:"datetime-local",name:"end_date",value:i.end_date,onChange:S,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Двор (Yard) *",e.jsxs("select",{name:"Yard",value:i.Yard,onChange:S,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200",children:[e.jsx("option",{value:"",children:"Выберите двор"}),C.map(s=>e.jsx("option",{value:s.name,children:s.name},s.id))]})]})]}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm font-medium text-gray-700",children:[e.jsx("input",{type:"checkbox",name:"weighing",checked:i.weighing,onChange:s=>x(t=>({...t,weighing:s.target.checked})),className:"form-checkbox h-5 w-5 text-blue-600"}),e.jsx("span",{children:"Весовой контроль (weighing)"})]}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm font-medium text-gray-700",children:[e.jsx("input",{type:"checkbox",name:"weighing",checked:i.one_permission,onChange:s=>x(t=>({...t,one_permission:s.target.checked})),className:"form-checkbox h-5 w-5 text-blue-600"}),e.jsx("span",{children:"Одноразовый заезд"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Склады и ворота"}),i.warehouse.map((s,t)=>e.jsxs("div",{className:"border rounded p-4 mb-4 relative bg-gray-50",children:[e.jsx("button",{type:"button",onClick:()=>B(t),className:"absolute top-2 right-2 text-red-500 hover:text-red-700 text-lg font-bold",title:"Удалить склад",children:"×"}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Склад ",t+1,e.jsxs("select",{name:"name","data-index":t,value:s.name,onChange:S,className:"w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 mt-1",children:[e.jsx("option",{value:"",children:"Выберите склад"}),T.map(a=>e.jsx("option",{value:a.name,children:a.name},a.id))]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Порядок сортировки",e.jsx("input",{type:"number",name:"sorting_order","data-index":t,value:s.sorting_order,min:1,onChange:S,className:"w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 mt-1"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Ворота (plan_gate)",e.jsxs("select",{name:"plan_gate","data-index":t,value:s.plan_gate||"",onChange:S,disabled:!Array.isArray(y[t])||y[t].length===0,className:"w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 mt-1",children:[e.jsx("option",{value:"",children:"Выберите ворота"}),Array.isArray(y[t])&&y[t].map(a=>e.jsx("option",{value:a.name,children:a.name},a.id))]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Описание",e.jsx("textarea",{name:"description","data-index":t,value:s.description||"",onChange:S,rows:2,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]})]},t)),e.jsx("button",{type:"button",onClick:z,className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition",children:"Добавить склад"})]}),e.jsxs("div",{className:"flex justify-end space-x-4 pt-4 border-t",children:[e.jsx("button",{onClick:j,className:"px-4 py-2 rounded border border-gray-400 hover:border-gray-600 transition",children:"Отмена"}),e.jsx("button",{onClick:n,className:"px-6 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition",children:"Сохранить"})]})]})}):null},Q=b=>{if(!b)return"—";const p=new Date(b);return new Intl.DateTimeFormat("ru-RU",{day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(p)},ae=({tasks:b,fetchTasks:p})=>{const[j,C]=d.useState(null),N=j!==null,T=()=>{C(null),p()};return e.jsxs(e.Fragment,{children:[e.jsx(re,{taskId:j,isOpen:N,onClose:()=>C(null),onSaved:T}),e.jsx("div",{className:"overflow-x-auto rounded-lg shadow border border-gray-300",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 text-sm",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-3 text-center font-semibold w-12",children:"ID"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold",children:"Рейс / Статус"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold",children:"План / Прибытие / Убытие"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold",children:"Описание"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold",children:"Автопарк"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold",children:"Контакты / Водитель"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold",children:"Погрузка"}),e.jsx("th",{className:"px-4 py-3 text-center font-semibold w-24",children:"Действия"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100",children:b.map(c=>e.jsxs("tr",{className:"hover:bg-gray-50 cursor-pointer",title:`Рейс ${c.name}, Статус: ${c.status_name}`,children:[e.jsx("td",{className:"px-4 py-3 text-center font-mono text-gray-600",children:c.id}),e.jsxs("td",{className:"px-4 py-3 space-y-1",children:[e.jsx("div",{className:"font-semibold",children:c.name}),e.jsx("div",{className:"text-sm text-gray-500",children:c.status_name}),e.jsx("div",{className:"text-xs text-gray-400",children:c.yard_name})]}),e.jsxs("td",{className:"px-4 py-3 space-y-1 font-mono",children:[e.jsxs("div",{children:["План: ",Q(c.plan_date)]}),e.jsxs("div",{children:["Прибытие: ",Q(c.begin_date)]}),e.jsxs("div",{children:["Убытие: ",Q(c.end_date)]})]}),e.jsx("td",{className:"px-4 py-3 max-w-xs break-words",children:c.description||"—"}),e.jsxs("td",{className:"px-4 py-3 space-y-1 text-xs font-mono",children:[e.jsxs("div",{children:[e.jsx("b",{children:"Тр.: "}),c.truck_plate_number]}),c.trailer_plate_number&&e.jsxs("div",{children:[e.jsx("b",{children:"Пр.: "}),c.trailer_plate_number]}),c.truck_model&&e.jsxs("div",{children:[e.jsx("b",{children:"Модель: "}),c.truck_model]}),c.truck_category_name&&e.jsxs("div",{children:[e.jsx("b",{children:"Катег.: "}),c.truck_category_name]}),c.color&&e.jsxs("div",{children:[e.jsx("b",{children:"Цвет: "}),c.color]})]}),e.jsxs("td",{className:"px-4 py-3 space-y-1 text-sm",children:[e.jsxs("div",{children:[e.jsx("b",{children:"Автор: "}),c.avtor,c.phone&&` (${c.phone})`]}),e.jsxs("div",{children:[e.jsx("b",{children:"Водитель: "}),c.user_name]}),e.jsxs("div",{children:[e.jsx("b",{children:"Логин: "}),c.user_login]}),e.jsxs("div",{children:[e.jsx("b",{children:"Телефон: "}),c.user_phone]})]}),e.jsx("td",{className:"px-4 py-3 space-y-3 text-xs max-w-[220px]",children:c.task_loadings.length===0?e.jsx("div",{children:"—"}):c.task_loadings.map((y,u)=>e.jsxs("div",{className:"p-2 bg-gray-50 rounded border",children:[e.jsx("div",{className:"font-semibold",children:y.warehouse_name}),e.jsxs("div",{children:["План: ",y.warehouse_gate_plan_name||"—"]}),e.jsxs("div",{children:["Факт: ",y.warehouse_gate_fact_name||"—"]})]},u))}),e.jsx("td",{className:"px-4 py-3 text-center",children:e.jsx("button",{onClick:()=>C(c.id),className:"bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm",children:"Изменить"})})]},c.id))})]})})]})},ne={name:"",sorting_order:1,gates:[],plan_gate:null,description:null},X={task_id:null,name:"",login:"",user_name:"",user_phone:"",company:"",plate_number:"",trailer_plate_number:"",truck_model:"",truck_category:"",trailer_type:"",trailer_model:"",color:"",vin:"",avtor:"",phone:"",Yard:"",description:"",plan_date:"",end_date:"",weighing:!1,create_user_id:"",one_permission:!1,warehouse:[{...ne}]},oe=({isOpen:b,onClose:p})=>{var D;const[j,C]=d.useState([]),[N,T]=d.useState([]),[c,y]=d.useState({}),[u,i]=d.useState(X),[x,$]=d.useState([]),[v,A]=d.useState(""),[M,E]=d.useState(!1),[f,m]=d.useState(null),[k,Y]=d.useState(null),[G,W]=d.useState(null),[P,H]=d.useState();d.useEffect(()=>{const n=sessionStorage.getItem("user");if(n){const r=JSON.parse(n);H(r.id)}},[]),d.useEffect(()=>{b&&_.get("/users/without-roles").then(n=>$(n.data)).catch(()=>$([]))},[b]),d.useEffect(()=>{b&&(_.post("/yard/getyards").then(n=>{const r=n.data.data;Array.isArray(r)?C(r):C([])}).catch(()=>C([])),_.post("/warehouse/getwarehouses").then(n=>{const r=n.data.data;Array.isArray(r)?T(r):T([])}).catch(()=>T([])))},[b]),d.useEffect(()=>{if(!v.trim()){m(null);return}k&&clearTimeout(k);const n=setTimeout(()=>{U()},600);Y(n)},[v]);const U=async()=>{if(v.trim()){E(!0);try{const n=await _.get("/trucs/search",{params:{plate_number:v}});m(n.data.found?n.data.data:null)}catch(n){console.error(n),m(null)}finally{E(!1)}}},q=()=>{alert("Создание ТС пока не реализовано")},R=()=>{f&&(i(n=>({...n,plate_number:f.plate_number,truck_model:f.truck_model_name||"",truck_category:f.truck_category_name||"",trailer_type:f.trailer_type_name||"",trailer_model:f.trailer_model_name||"",color:f.color||"",vin:f.vin||""})),W(f))},L=(n,r)=>{const s=N.find(t=>t.name===n);if(!s){y(t=>{const a={...t};return delete a[r],a}),i(t=>{const a=[...t.warehouse];return a[r].plan_gate=null,a[r].gates=[],{...t,warehouse:a}});return}_.post("/warehouse/getgates",{warehouse_id:s.id}).then(t=>{const a=t.data.data;Array.isArray(a)?(y(o=>({...o,[r]:a})),i(o=>{const l=[...o.warehouse];return l[r].gates=a.map(h=>h.name),a.some(h=>h.name===l[r].plan_gate)||(l[r].plan_gate=null),{...o,warehouse:l}})):(y(o=>{const l={...o};return delete l[r],l}),i(o=>{const l=[...o.warehouse];return l[r].plan_gate=null,l[r].gates=[],{...o,warehouse:l}}))}).catch(()=>{y(t=>{const a={...t};return delete a[r],a}),i(t=>{const a=[...t.warehouse];return a[r].plan_gate=null,a[r].gates=[],{...t,warehouse:a}})})},J=n=>{const r=Number(n.target.value),s=x.find(t=>t.id===r);i(t=>({...t,user_name:s.user_name,login:s.login,user_phone:s.user_phone}))},w=n=>{const{name:r,type:s,value:t,checked:a,dataset:o}=n.target;if(o.index!==void 0){const l=Number(o.index);i(h=>{const g=[...h.warehouse],I={...g[l]};return r==="sorting_order"?I.sorting_order=Number(t):r==="plan_gate"?I.plan_gate=t||null:r==="description"?I.description=t||null:I.name=t,g[l]=I,{...h,warehouse:g}}),r==="name"&&L(t,l)}else i(s==="checkbox"?l=>({...l,[r]:a}):l=>({...l,[r]:t}))},V=()=>{i(n=>{const r=[...n.warehouse];return r.push({name:"",sorting_order:r.length+1,gates:[],plan_gate:null,description:null}),{...n,warehouse:r}})},S=n=>{i(r=>{const s=r.warehouse.filter((t,a)=>a!==n);return s.forEach((t,a)=>t.sorting_order=a+1),{...r,warehouse:s}}),y(r=>{const s={...r};return delete s[n],s})},z=n=>{const r=new Date(n),s=t=>String(t).padStart(2,"0");return`${r.getFullYear()}-${s(r.getMonth()+1)}-${s(r.getDate())} ${s(r.getHours())}:${s(r.getMinutes())}:${s(r.getSeconds())}`},B=async()=>{var n;try{const r=u.warehouse.map(t=>({name:t.name,sorting_order:t.sorting_order,gates:t.gates,plan_gate:t.plan_gate,description:t.description,barcode:t.barcode??null,yard:t.yard??null,document:t.document??null})),s={...u,task_id:u.task_id??null,plan_date:z(u.plan_date),end_date:z(u.end_date),warehouse:r,create_user_id:P};console.log("Payload:",s),await _.post("/api/task/addapitask",s),alert("Задача успешно добавлена"),p(),i(X),y({})}catch(r){const s=r;s.response?(console.error("Response data:",s.response.data),console.error("Status:",s.response.status),console.error("Headers:",s.response.headers),alert("Ошибка сервера: "+(((n=s.response.data)==null?void 0:n.message)||"Неизвестная ошибка"))):(console.error("Unexpected error:",r),alert("Произошла неизвестная ошибка"))}};return b?e.jsx("div",{className:"fixed inset-0 bg-gray-400/20 bg-opacity-10 backdrop-blur-sm flex items-center justify-center z-50 p-4 overflow-auto",children:e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-xl w-full max-w-4xl max-h-[90vh] overflow-y-auto space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center border-b pb-3",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800",children:"Добавить задачу"}),e.jsx("button",{onClick:p,className:"text-gray-500 hover:text-red-600 text-2xl",children:"×"})]}),e.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-4",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Название задачи (name) *",e.jsx("input",{type:"text",name:"name",value:u.name,onChange:w,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Автор (автор) *",e.jsx("input",{type:"text",name:"avtor",value:u.avtor,onChange:w,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Выберите пользователя",e.jsxs("select",{name:"user_id",value:u.login?((D=x.find(n=>n.login===u.login))==null?void 0:D.id)??"":"",onChange:J,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200",children:[e.jsx("option",{value:"",children:"— Выберите —"}),x.map(n=>e.jsx("option",{value:n.id,children:n.user_name},n.id))]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Компания (company)",e.jsx("input",{type:"text",name:"company",value:u.company,onChange:w,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Поиск ТС по номеру23",e.jsxs("div",{className:"flex mt-1",children:[e.jsx("input",{type:"text",value:v,onChange:n=>A(n.target.value),placeholder:"Введите номер машины",className:"flex-1 border border-gray-300 rounded-l px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200"}),e.jsx("button",{type:"button",onClick:U,disabled:M,className:"bg-blue-600 text-white px-4 py-2 rounded-r hover:bg-blue-700 disabled:opacity-50",children:M?"Поиск...":"Найти"})]})]}),f!==null?e.jsxs("div",{className:"p-3 bg-green-50 rounded border border-green-200",children:[e.jsx("p",{className:"text-green-800",children:"ТС найдено:"}),e.jsxs("ul",{className:"text-gray-700",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"Номер:"})," ",f.plate_number]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Модель:"})," ",f.truck_model_name]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Прицеп:"})," ",f.trailer_model_name]}),e.jsxs("li",{children:[e.jsx("strong",{children:"Цвет:"})," ",f.color]}),e.jsxs("li",{children:[e.jsx("strong",{children:"VIN:"})," ",f.vin]})]}),G?e.jsx("button",{type:"button",onClick:()=>{W(null),m(null),A("")},className:"mt-2 bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700",children:"Отвязать ТС"}):e.jsx("button",{type:"button",onClick:R,className:"mt-2 bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700",children:"Выбрать ТС"})]}):!M&&v&&e.jsxs("div",{className:"p-3 bg-yellow-50 rounded border border-yellow-200",children:[e.jsx("p",{className:"text-yellow-800",children:"ТС с таким номером не найдено."}),e.jsx("button",{type:"button",onClick:q,className:"mt-2 bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700",children:"Создать ТС"})]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Описание (description)",e.jsx("textarea",{name:"description",value:u.description,onChange:w,rows:2,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Дата планирования (plan_date)",e.jsx("input",{type:"datetime-local",name:"plan_date",value:u.plan_date,onChange:w,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Телефон (phone)",e.jsx("input",{type:"text",name:"phone",value:u.phone,onChange:w,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Крайний срок (end_date)",e.jsx("input",{type:"datetime-local",name:"end_date",value:u.end_date,onChange:w,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Двор (Yard) *",e.jsxs("select",{name:"Yard",value:u.Yard,onChange:w,required:!0,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200",children:[e.jsx("option",{value:"",children:"Выберите двор"}),j.map(n=>e.jsx("option",{value:n.name,children:n.name},n.id))]})]})]}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm font-medium text-gray-700",children:[e.jsx("input",{type:"checkbox",name:"weighing",checked:u.weighing,onChange:n=>i(r=>({...r,weighing:n.target.checked})),className:"form-checkbox h-5 w-5 text-blue-600"}),e.jsx("span",{children:"Весовой контроль (weighing)"})]}),e.jsxs("label",{className:"flex items-center space-x-2 text-sm font-medium text-gray-700",children:[e.jsx("input",{type:"checkbox",name:"weighing",checked:u.one_permission,onChange:n=>i(r=>({...r,one_permission:n.target.checked})),className:"form-checkbox h-5 w-5 text-blue-600"}),e.jsx("span",{children:"Одноразовый заезд"})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Склады и ворота"}),u.warehouse.map((n,r)=>e.jsxs("div",{className:"border rounded p-4 mb-4 relative bg-gray-50",children:[e.jsx("button",{type:"button",onClick:()=>S(r),className:"absolute top-2 right-2 text-red-500 hover:text-red-700 text-lg font-bold",title:"Удалить склад",children:"×"}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Склад ",r+1,e.jsxs("select",{name:"name","data-index":r,value:n.name,onChange:w,className:"w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 mt-1",children:[e.jsx("option",{value:"",children:"Выберите склад"}),N.map(s=>e.jsx("option",{value:s.name,children:s.name},s.id))]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Порядок сортировки",e.jsx("input",{type:"number",name:"sorting_order","data-index":r,value:n.sorting_order,min:1,onChange:w,className:"w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 mt-1"})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:["Ворота (plan_gate)",e.jsxs("select",{name:"plan_gate","data-index":r,value:n.plan_gate||"",onChange:w,disabled:!Array.isArray(c[r])||c[r].length===0,className:"w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring focus:ring-blue-200 mt-1",children:[e.jsx("option",{value:"",children:"Выберите ворота"}),Array.isArray(c[r])&&c[r].map(s=>e.jsx("option",{value:s.name,children:s.name},s.id))]})]}),e.jsxs("label",{className:"block text-sm font-medium text-gray-700",children:["Описание",e.jsx("textarea",{name:"description","data-index":r,value:n.description||"",onChange:w,rows:2,className:"w-full border border-gray-300 rounded px-3 py-2 mt-1 focus:outline-none focus:ring focus:ring-blue-200"})]})]},r)),e.jsx("button",{type:"button",onClick:V,className:"bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition",children:"Добавить склад"})]}),e.jsxs("div",{className:"flex justify-end space-x-4 pt-4 border-t",children:[e.jsx("button",{onClick:p,className:"px-4 py-2 rounded border border-gray-400 hover:border-gray-600 transition",children:"Отмена"}),e.jsx("button",{onClick:B,className:"px-6 py-2 rounded bg-green-600 text-white hover:bg-green-700 transition",children:"Сохранить"})]})]})}):null},le=()=>{const[b,p]=d.useState([]),[j,C]=d.useState(!1),[N,T]=d.useState(null),[c,y]=d.useState(1),[u,i]=d.useState(1),[x,$]=d.useState(!1),v=sessionStorage.getItem("user");let A=!1;if(v)try{const m=JSON.parse(v);A=Array.isArray(m.roles)&&m.roles.includes("Снабженец")}catch(m){console.error("Ошибка парсинга user из sessionStorage:",m)}const M=m=>{C(!0),T(null),_.post("/task/gettasks",{page:m}).then(k=>{k.data.status?(p(k.data.data.tasks||k.data.data),i(k.data.data.totalPages||1)):(T("Ошибка при загрузке задач"),p([]))}).catch(k=>{T(k.message||"Ошибка запроса"),p([])}).finally(()=>{C(!1)})};d.useEffect(()=>{M(c)},[c]);const E=()=>y(m=>Math.max(1,m-1)),f=()=>y(m=>Math.min(u,m+1));return e.jsxs("div",{className:"p-5",children:[A&&e.jsx("div",{className:"mb-4",children:e.jsx("button",{onClick:()=>$(!0),className:"px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Добавить"})}),j&&e.jsx("div",{children:"Загрузка задач..."}),N&&e.jsxs("div",{className:"text-red-600",children:["Ошибка: ",N]}),!j&&!N&&b.length===0&&e.jsx("div",{children:"Задачи не найдены"}),!j&&!N&&b.length>0&&e.jsx(ae,{tasks:b}),e.jsxs("div",{className:"mt-4 flex items-center justify-center space-x-4",children:[e.jsx("button",{onClick:E,disabled:c===1||j,className:`px-4 py-2 rounded border ${c===1||j?"bg-gray-200 cursor-not-allowed":"bg-white hover:bg-gray-100"}`,children:"Назад"}),e.jsxs("span",{className:"text-gray-700",children:["Страница ",c," из ",u]}),e.jsx("button",{onClick:f,disabled:c===u||j,className:`px-4 py-2 rounded border ${c===u||j?"bg-gray-200 cursor-not-allowed":"bg-white hover:bg-gray-100"}`,children:"Вперед"})]}),e.jsx(oe,{isOpen:x,onClose:()=>$(!1)})]})};function pe(){const{t:b}=te(),p=[{title:b("tasks"),href:"/tasks"}];return e.jsxs(ee,{breadcrumbs:p,children:[e.jsx(Z,{title:b("tasks")}),e.jsx(le,{})]})}export{pe as default};
